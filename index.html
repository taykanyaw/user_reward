<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ - ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</title>
  <link rel="preload" href="https://media.tenor.com/pEDQL3XJxdsAAAAi/cat-cute.gif" as="image">
  <script defer src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/party-js@latest/bundle/party.min.js"></script>
  <style>
    .preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.3s ease-out;
      will-change: opacity;
    }
    .preloader img {
      width: 150px;
      height: 150px;
    }
    .profile-img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #ffffff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border-radius: 1rem;
    }
    .chart-container {
      max-width: 250px;
      margin: 0 auto;
      overflow: hidden;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
    }
    @media (max-width: 640px) {
      .profile-img {
        width: 80px;
        height: 80px;
      }
      .chart-container {
        max-width: 200px;
      }
      .glass-card {
        padding: 1rem;
      }
      .preloader img {
        width: 150px;
        height: 150px;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 to-gray-200 font-sans min-h-screen">
  <!-- Preloader -->
  <div id="preloader" class="preloader">
    <img src="https://media.tenor.com/pEDQL3XJxdsAAAAi/cat-cute.gif" alt="Loading" loading="eager">
  </div>

  <!-- Main Content -->
  <div id="main-content" class="container mx-auto p-4 sm:p-6 hidden">
    <header class="text-center mb-8">
      <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</h1>
      <p class="text-lg text-gray-700 mt-2">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </header>
    
    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Profile Card -->
        <div class="glass-card p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold text-blue-800">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>
            <button id="closeButton" class="bg-blue-500/20 text-blue-600 px-3 py-1 rounded-lg hover:bg-blue-500/30 transition text-sm flex items-center">
              ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏û
            </button>
          </div>
          <div class="flex items-center mb-4">
            <img id="profile-pic" class="profile-img mr-4" alt="Profile Picture">
            <div>
              <p class="text-lg"><strong class="text-blue-600">LINE:</strong> <span id="line-name" class="text-gray-800"></span> üíï</p>
            </div>
          </div>
          <p class="text-lg"><strong class="text-blue-600">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> <span id="student-name" class="text-gray-800"></span></p>
          <p class="text-lg"><strong class="text-blue-600">‡∏ä‡∏±‡πâ‡∏ô:</strong> <span id="student-class" class="text-gray-800"></span></p>
          <p class="text-lg"><strong class="text-blue-600">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> <span id="student-number" class="text-gray-800"></span></p>
        </div>

        <!-- Score Card -->
        <div class="glass-card p-6">
          <h2 class="text-2xl font-semibold text-blue-800 mb-4">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
          <p class="text-lg"><strong class="text-blue-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ:</strong> <span id="good-deeds" class="text-blue-600 font-medium"></span></p>
          <p class="text-lg"><strong class="text-emerald-600">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°:</strong> <span id="points" class="text-emerald-600 font-medium"></span></p>
          <p class="text-lg"><strong class="text-red-600">‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©:</strong> <span id="extra-points" class="text-red-600 font-medium"></span></p>
        </div>

        <!-- Charts Card -->
        <div class="glass-card p-6">
          <h2 class="text-2xl font-semibold text-blue-800 mb-4 text-center">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
          <div class="grid grid-cols-1 gap-4">
            <div class="chart-container">
              <canvas id="goodDeedsChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="pointsChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="extraPointsChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gradient-to-r from-blue-700 to-purple-700 text-center py-4 mt-6">
      <p class="text-white text-lg">¬©Ô∏è <span id="currentYear"></span> ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ <span class="text-red-600">üê∞‡∏Ñ‡∏£‡∏π‡∏£‡∏±‡∏ï‡∏ô‡∏≤‡∏û‡∏£  ‡πÅ‡∏™‡∏ô‡πÉ‡∏´‡∏ç‡πàüê∞</span></p>
    </footer>
  </div>

  <script>
    let goodDeedsChartInstance = null;
    let pointsChartInstance = null;
    let extraPointsChartInstance = null;
    const liffId = '2007658443-wzozjWjx';

    // Update current year in footer
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // Check if external scripts are loaded
    function checkScripts() {
      if (!window.liff || !window.Swal || !window.Chart) {
        document.getElementById('preloader').classList.add('hidden');
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï', 'error');
        return false;
      }
      return true;
    }

    // Initialize LINE LIFF
    function initializeLiff() {
      if (!checkScripts()) return;

      liff
        .init({ liffId })
        .then(() => {
          console.log('LIFF initialized successfully');
          liff.ready.then(() => {
            console.log('LIFF is ready');
            // Show main content but keep preloader visible until checkUID completes
            document.getElementById('main-content').classList.remove('hidden');
          });

          // Check login status
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            // Get user profile
            liff
              .getProfile()
              .then((profile) => {
                const name = profile.displayName;
                const userId = profile.userId;
                const pictureUrl = profile.pictureUrl;
                console.log('User Profile:', { name, userId, pictureUrl });
                // Display profile (UID is not shown on the page but still used for checking)
                document.getElementById('line-name').textContent = name;
                if (pictureUrl) {
                  document.getElementById('profile-pic').src = pictureUrl;
                }

                // Check UID
                checkUID(userId);
              })
              .catch((err) => {
                console.error('Error getting profile:', err);
                document.getElementById('preloader').classList.add('hidden');
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
              });
          }

          // Check if running in LINE client
          if (liff.isInClient()) {
            console.log('Running in LINE client');
          } else {
            console.log('Running in external browser');
          }
        })
        .catch((err) => {
          console.error('LIFF initialization failed:', err);
          document.getElementById('preloader').classList.add('hidden');
          Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE LIFF ‡πÑ‡∏î‡πâ', 'error');
        });
    }

    // Check UID
    async function checkUID(uid) {
      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbw-U6wOufy4gzRNU7NqPsdy9HIzgPaqk59NMvY-BP_bfWYUyY-c7_Q-L-YSiuRpFhDFdQ/exec');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        const user = data.find(item => item.UID === uid);
        
        if (user) {
          document.getElementById('dashboard').classList.remove('hidden');
          // Display data
          document.getElementById('student-name').textContent = `${user.‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠} ${user.‡∏ä‡∏∑‡πà‡∏≠} ${user.‡∏™‡∏Å‡∏∏‡∏•}`;
          document.getElementById('student-class').textContent = user.‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô;
          document.getElementById('student-number').textContent = user.‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà;
          document.getElementById('good-deeds').textContent = user.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ;
          document.getElementById('points').textContent = user.‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°;
          document.getElementById('extra-points').textContent = user.‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©;
          
          // Render Charts
          renderCharts(user);

          // Hide preloader after dashboard is visible
          document.getElementById('preloader').classList.add('hidden');

          // Trigger confetti after preloader is hidden
          party.confetti(document.body, {
            count: party.variation.range(50, 100),
            size: party.variation.range(0.8, 1.2),
            spread: 70
          });
        } else {
          document.getElementById('preloader').classList.add('hidden');
          Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', 'error');
        }
      } catch (error) {
        console.error('Error fetching data:', error);
        document.getElementById('preloader').classList.add('hidden');
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
      }
    }

    // Render Charts
    function renderCharts(user) {
      // Good Deeds Chart
      const goodDeedsCtx = document.getElementById('goodDeedsChart').getContext('2d');
      if (goodDeedsChartInstance) goodDeedsChartInstance.destroy();
      goodDeedsChartInstance = new Chart(goodDeedsCtx, {
        type: 'doughnut',
        data: {
          labels: ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ'],
          datasets: [{
            data: [user.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ, 100 - user.‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ],
            backgroundColor: ['#3b82f6', '#e5e7eb'],
            borderColor: ['#2563eb', '#d1d5db'],
            borderWidth: 2
          }]
        },
        options: {
          animation: { duration: 2000, easing: 'easeInOutQuad' },
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          rotation: -90,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 12, weight: 'bold' }, color: '#1f2937' } },
            tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)' }
          },
          aspectRatio: 1
        }
      });

      // Points Chart
      const pointsCtx = document.getElementById('pointsChart').getContext('2d');
      if (pointsChartInstance) pointsChartInstance.destroy();
      pointsChartInstance = new Chart(pointsCtx, {
        type: 'doughnut',
        data: {
          labels: ['‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°'],
          datasets: [{
            data: [user.‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°, 100 - user.‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°],
            backgroundColor: ['#10b981', '#e5e7eb'],
            borderColor: ['#059669', '#d1d5db'],
            borderWidth: 2
          }]
        },
        options: {
          animation: { duration: 2000, easing: 'easeInOutQuad' },
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          rotation: -90,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 12, weight: 'bold' }, color: '#1f2937' } },
            tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)' }
          },
          aspectRatio: 1
        }
      });

      // Extra Points Chart
      const extraPointsCtx = document.getElementById('extraPointsChart').getContext('2d');
      if (extraPointsChartInstance) extraPointsChartInstance.destroy();
      extraPointsChartInstance = new Chart(extraPointsCtx, {
        type: 'doughnut',
        data: {
          labels: ['‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©'],
          datasets: [{
            data: [user.‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©, 100 - user.‡πÅ‡∏ï‡πâ‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©],
            backgroundColor: ['#ef4444', '#e5e7eb'],
            borderColor: ['#dc2626', '#d1d5db'],
            borderWidth: 2
          }]
        },
        options: {
          animation: { duration: 2000, easing: 'easeInOutQuad' },
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          rotation: -90,
          plugins: {
            legend: { position: 'top', labels: { font: { size: 12, weight: 'bold' }, color: '#1f2937' } },
            tooltip: { enabled: true, backgroundColor: 'rgba(0, 0, 0, 0.8)' }
          },
          aspectRatio: 1
        }
      });
    }

    // Add close button event listener
    document.getElementById('closeButton').addEventListener('click', () => {
      if (window.liff) {
        liff.closeWindow();
      } else {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
      }
    });

    // Initialize on page load
    window.onload = () => {
      initializeLiff();
    };
  </script>
</body>
</html>
